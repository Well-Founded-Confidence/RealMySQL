# 전문 검색
- 용량이 큰 문서를 단어 수준으로 잘게 쪼개어 문서 검색을 하게 해주는 기능
- 예전에는 일부 스토리지 엔진을 사용하는 테이블만 전문 검색 기능을 활용할 수 있었다.
- MySQL 8.0에서는 InnoDB 스토리지 엔진에서도 사용할 수 있도록 개선됨

## 전문 검색 인덱스의 생성과 검색
- MySQL 서버에서는 2가지 알고리즘을 이용해서 인덱싱할 토큰을 분리한다.
	- 형태소 분석
	- n-gram 파서
- 형태소 분석은 문장의 공백과 같은 띄어쓰기 단위로 단어를 분리하고, 각 단어의 조사를 제거해서 명사 or 어근을 찾아서 인덱싱하는 알고리즘
	- MySQL 서버에서는 형태소 분석이나 어근 분석 기능은 구현되어 있지 않음
- n-gram은 문장 자체에 대한 이해 없이 공백과 같은 띄어쓰기 단위로 단어를 분리하고, 그 단어를 단순히 주어진 길이로 쪼개서 인덱싱하는 알고리즘

### n-gram
- n-gram에서 n은 1 ~ 10 사이의 숫자 값
	- ngram_token_size 시스템 변수로 변경할 수 있음
	- default는 2
	- `n == 1`이면 uni-Gram, `n == 2`이면 bi-gram, `n == 3`이면 tri-gram
	- 3보다 큰 값은 설정값에 따라 검색어의 길이 제약이 생기기 때문에 `bi-gram`, `tri-gram`이 일반적으로 많이 사용됨
- `bi-gram`, `tri-gram` 테스트는 각각 ngram_token_size를 변경해서 MySQL 서버를 재시작한 후 테스트해야 한다.
- 테이블의 전문 검색 인덱스를 생성할 때 `with parser ngram` 옵션을 추가해야 n-gram 파서를 사용해서 토큰을 생성할 수 있다.
	- 아니면 MySQL 서버는 기본 파서를 사용해서 전문 인덱스를 생성한다.

```sql
	-- my.cnf 설정 파일에 ngram_token_size=2 or 3; 추가한 후 재시작

	-- 테스트 테이블과 데이터 준비
	create table tb_bi_gram (
		id bigint not null auto_increment,
		title varchar(100),
		body text,
		primary key(id),
		fulltext index fx_msg(title, body) with parser ngram
	);

	insert into tb_bi_gram values (null, 'Real MySQL', 'body');

	select count(*) from tb_gi_gram
		where match(title, body) against ('text' in boolean mode);
```
- 검색어의 길이가 ngram_token_size보다 작은 경우는 검색 불가능
- 검색어의 길이가 ngram_token_size보다 크거나 같은 경우는 검색 가능
- ngram_token_size 시스템 변수는 응용프로그램에서 검색하고자 하는 검색어의 길이에 맞게 설정해야 한다.
- 검색어가 단어의 시작, 중간, 끝 부분이어도 n-gram이 검색할 수 있다.
	![img](./img/n_gram_token.png)
	- ngram_token_size보다 길이가 작은 단어는 모두 버려진다.
- n-gram 파서는 전문 검색 인덱스 생성때만 사용되는 것이 아니라 쿼리의 전문 검색에서도 사용된다.
	```sql
		select count(*) from tb_bi_gram
		where match(title, body) against ('단편적인' in boolean mode);
	```
- 이미 2글자씩 잘라낸 토큰을 인덱스에 저장한 상태에서 4글자의 검색어를 이용해서 결과를 찾으려면?
	- 이전 방식과 동일하게 검색어를 시스템 변수에 맞게 토큰으로 만들고, 토큰들을 전문 검색 인덱스를 이용해서 동등 비교 조건으로 검색한다.
