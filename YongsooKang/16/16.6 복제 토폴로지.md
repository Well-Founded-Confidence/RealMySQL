## 싱글 레플리카 복제 구성
> 하나의 소스 서버에 하나의 레플리카 서버만 연결된 형태

![img](./img/16.13%20싱글%20레플리카%20복제%20구성.png)
- 가장 기본적이고 가장 많이 쓰임
- 애플리케이션 서버는 소스 서버에만 직접적으로 접근, 레플리카 서버에 접근 x
- 레플리카 서버는 소스 서버에 장애가 발생했을 때 백업용도로 사용
  - 레플리카 서버에 읽기 쿼리를 실행한다면 레플리카 서버에 장애가 발생했을 때 서비스 전체에 문제될 수 있음

## 멀티 레플리카 복제 구성
> 하나의 소스 서버에 2개 이상의 레플리카 서버를 연결한 형태

![img](./img/16.14%20멀티%20레플리카%20복제%20구성.png)
- 서비스의 트래픽 증가 시 대부분은 읽기 요청 -> 레플리카 서버에서 요청을 분산처리
- 레플리카 서버 한대는 예비용으로 남겨두는 것이 좋음
  - 소스 서버나 다른 레플리카 서버에 장애 발생 시 대체하는 용도로 사용
- 레플리카 서버에 장애가 발생했을때 최대한 빠르게 복구되어야함
  - 그렇지 않으면 다른 레플리카 서버가 쿼리 요청을 넘겨받아서 처리
  - 이로 인해 부하가 커져서 성능 저하가 발생할 수 있음

## 체인 복제 구성
![img](./img/16.15%20체인%20복제%20구성.png)
- 레플리카 서버가 너무 많아서 소스 서버의 성능에 악영향이 예상될 때 고려
- 소스 서버는 레플리카 서버가 요청할 때마다 바이너리 로그를 읽어서 전달해야 함
  - 레플리카 서버의 수가 많다면 이 작업 자체가 부하가 될 수 있음
  - 복제 그룹을 나눠서 로그 배포 역할을 다른 서버로 넘길 수 있음

## 듀얼 소스 복제 구성
> 두 개의 MySQL 서버가 서로 소스 서버이자 레플리카 서버로 구성되어 있는 형태

![img](./img/16.20%20듀얼%20소스%20복제%20구성.png)
- 두 서버 모두 쓰기가 가능
- 각 서버에서 변경한 한 데이터는 복제를 통해 각 서버에 적용되므로 양쪽에서 쓰기가 발생해도 두 서버는 동일한 데이터를 가짐
- 목적에 따라 MySQL 서버를 ACTIVE-PASSIVE or ACTIVE-ACTIVE 형태로 사용할 수 있음
  - ACTIVE-PASSIVE
    - 하나의 MySQL 서버에서만 쓰기 작업이 수행되는 형태
    - 예비 서버가 쓰기 작업이 가능한 상태라 문제 발생 시 별도의 설정 변경 없이 예비용 서버로 쓰기 작업을 전환할 수 있음
    - 한 서버에서 다른 서버로 바로 쓰기가 전환될 수 있는 환경이 필요할 때 사용
  - ACTIVE-ACTIVE
    - 두 서버 모두 쓰기 작업을 수행하는 형태
    - 지리적으로 떨어진 위치에서의 쓰기 요청도 원활하게 처리할 수 있음
    - 서로의 트랜잭션이 적용되기 전까지 두 서버는 일관되지 않은 데이터를 가질 수 있음을 유의
- 듀얼 소스 복제 구성을 사용할때 주의
  - 동일한 데이터를 각 서버에서 변경
  - 테이블에서 auto-increment key 사용

## 멀티 소스 복제 구성
> 하나의 레플리카 서버가 둘 이상의 소스 서버를 갖는 형태
> MySQL 5.7.6 버전에서 처음 도입

![img](./img/16.21%20멀티%20소스%20복제%20구성.png)
- 목적
  - 여러 MySQL 서버에 존재하는 각기 다른 데이터를 하나의 MySQL 서버로 통합
  - 여러 MySQL 서버에 샤딩돼 있는 테이블 데이터를 하나의 테이블로 통합
  - 여러 MySQL 서버의 데이터들을 모아 하나의 MySQL 서버에서 백업을 수행
- 분석에 필요한 데이터들이 여러 곳에 나눠져있어 이를 한곳으로 모아 좀 더 빠르고 편리하게 분석을 수행하고자 할 때 효율적
- 각 소스 서버로부터 유입되는 변경 이벤트들이 복제될때 충돌을 일으킬만한 부분이 없는지 검토가 필요함
- 레플리카 서버는 각 소스 서버들의 대체 서버로 사용하기는 어려움이 있으므로 장애 대비용 레플리카 서버는 각 소스 서버와 1:1 복제로 연결된 별도의 서버로 구축하는 것이 좋음

### 멀티 소스 복제 동작
![img](./img/16.22%20멀티%20소스%20복제%20동작%20방식.png)
- 자신과 연결된 소스 서버들의 변경 이벤트들을 동시점에 병렬로 동기화한다.
  - 각 소스 서버들에 대한 복제가 독립적으로 처리됨
  - 각각의 독립된 복제 처리를 `채널`이라고 함
- `CHANGE REPLICATION SOURCE TO` 명령에서 `FOR CHANNEL` 구문을 사용해서 복제 채널명 지정 가능

### 멀티 소스 복제 구축
- 여러 대의 소스 서버의 백업 데이터를 레플리카 서버로 가져와야함
- 소스, 레플리카 서버 모두 초기 데이터가 없다면 멀티 소스 복제 연결만 하면 됨
- 1개의 소스 서버만 데이터를 갖고 있다면 해당 서버의 백업 데이터를 레플리카 서버에 복구한다.
- 2개 이상의 소스 서버가 초기 데이터를 갖고 있다면 DB와 InnoDB의 시스템 테이블 스페이스의 충돌과 병합을 고려해야 함
  - mysqldump와 같은 논리 수준의 백업 도구 이용
    - InnoDB의 시스템 테이블 스페이스를 물리적으로 백업하는 것이 아니므로 병합 관련 문제가 발생하지 않음
    - 백업된 데이터가 매우 크다면 시간이 오래걸림
  - XtraBackup과 같은 물리 수준의 백업 도구 이용
    - 대용량의 DB를 빠르게 레플리카 서버로 가져올 수 있음
    - 시스템 테이블 스페이스를 포함해서 MySQL 서버의 모든 데이터 파일들을 그대로 복사해서 복구
      - 시스템 테이블 스페이스를 문제없이 하나로 병합할 수 있는 방법은 없음
  - 위 두 가지를 적절히 혼합해서 사용하는 것이 좋음
- ex. 소스 서버 A, B, 레플리카 서버 C에서 멀티 소스 복제를 연결한다고 가정
  - A, B 모두 데이터가 크지 않은 경우
    - 둘 다 mysqldump로도 충분히 백업할 수 있음
  - A 서버는 데이터가 크고, B 서버는 작은 경우
    - 데이터가 작은 쪽은 mysqldump, 큰 쪽은 XtraBackup을 사용
  - A, B 모두 데이터가 큰 경우
    - 둘 다 XtraBackup 사용
